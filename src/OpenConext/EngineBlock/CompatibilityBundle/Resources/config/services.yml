services:
    eb.compat.application:
        class: EngineBlock_ApplicationSingleton
        factory:  [EngineBlock_ApplicationSingleton, getInstance]

    eb.compat.config:
        class: Zend_Config
        factory: ["@eb.compat.application", getConfiguration]

    eb.compat.engineblock_config:
        class: OpenConext\EngineBlock\CompatibilityBundle\Configuration\EngineBlockConfiguration
        arguments:
            - ~ # engineblock configuration array

    eb.compat.di_container:
        public: false
        class: EngineBlock_Application_DiContainer
        factory: ["@eb.compat.application", getDiContainer]

    eb.compat.repository.metadata:
        public: false
        class: OpenConext\Component\EngineBlockMetadata\MetadataRepository\MetadataRepositoryInterface
        factory: [@eb.compat.di_container, getMetadataRepository]

    eb.compat.doctrine.entity_manager:
        public: false
        class: Doctrine\ORM\EntityManager
        factory: [@eb.compat.di_container, getEntityManager]

    eb.compat.doctrine.dbal_connection:
        public: false
        class: Doctrine\DBAL\Connection
        factory: [@eb.compat.doctrine.entity_manager, getConnection]

    eb.compat.view:
        class: EngineBlock_View
        calls:
            - ['setLayout', [@eb.compat.layout]]

    eb.compat.log.error_level_activation_strategy:
        class: Monolog\Handler\FingersCrossed\ErrorLevelActivationStrategy
        arguments:
            - "@=service('eb.compat.config').logger.conf.handler.fingers_crossed.conf.activation_strategy.conf.action_level"

    eb.compat.log.manual_or_error_activation_strategy:
        class: EngineBlock_Log_Monolog_Handler_FingersCrossed_ManualOrDecoratedActivationStrategy
        arguments:
            - @eb.compat.log.error_level_activation_strategy

    eb.compat.log.line_formatter:
        class: Monolog\Formatter\LineFormatter
        arguments:
            - "@=service('eb.compat.config').logger.conf.handler.syslog.conf.formatter.conf.format"

    eb.compat.log.additional_info_formatter:
        class: EngineBlock_Log_Monolog_Formatter_AdditionalInfoFormatter
        arguments:
            - @eb.compat.log.line_formatter

    eb.compat.log.session_id_processor:
        class: EngineBlock_Log_Monolog_Processor_SessionIdProcessor
        tags:
            - { name: monolog.processor }

    eb.compat.log.request_id_processor:
        class: EngineBlock_Log_Monolog_Processor_RequestIdProcessor
        tags:
            - { name: monolog.processor }

    eb.compat.logger:
        class: Monolog\Logger
        factory:  [EngineBlock_ApplicationSingleton, getLog]

    eb.compat.layout:
        class: Zend_Layout
        calls:
            - ['setLayout',       ["@=service('eb.compat.config').defaults.layout"]]
            - ['setLayoutPath',   ["%kernel.root_dir%/Resources/views/layouts/scripts/"]]
            - ['setViewBasePath', ["%kernel.root_dir%/Resources/views/modules/"]]
        properties:
            title: "@=service('eb.compat.config').defaults.title"
            header: "@=service('eb.compat.config').defaults.header"

### Bridge classes

    eb.bridge.error_reporter:
        class: OpenConext\EngineBlock\CompatibilityBundle\Bridge\ErrorReporter
        arguments:
            - @eb.compat.application
            - @eb.compat.logger

    eb.bridge.mailer:
        class: OpenConext\EngineBlock\CompatibilityBundle\Bridge\ZendMailSender
        arguments:
            - "@=service('eb.compat.config').email.help"
            - @eb.compat.logger
